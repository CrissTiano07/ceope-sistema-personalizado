<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CEOPE - Via Livre</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 30px;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
        }
        .main-container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .system-header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .system-header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 600;
        }
        .system-header p {
            margin: 10px 0 0 0;
            font-size: 16px;
            opacity: 0.9;
        }
        .module-container {
            background-color: #ffffff;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        .module-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .module-header h2 {
            margin: 0;
            color: #1a3c34;
            font-size: 24px;
            font-weight: 600;
        }
        .module-header .icon {
            font-size: 28px;
            color: #4CAF50;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        .tab:hover {
            color: #4CAF50;
            background-color: #f5f5f5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .feature-card h3 {
            margin: 0 0 10px 0;
            color: #1a3c34;
            font-size: 18px;
        }
        .feature-card p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        /* Estilos do sistema original */
        h3 {
            color: #2e5e56;
            margin: 30px 0 20px;
            font-size: 20px;
            font-weight: 500;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        label {
            font-weight: 600;
            display: block;
            margin-top: 20px;
            color: #333;
            font-size: 16px;
        }
        label.required::after {
            content: " *";
            color: #d32f2f;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 15px;
            background-color: #fafafa;
            transition: border-color 0.3s;
            text-transform: uppercase;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4CAF50;
            outline: none;
            background-color: #fff;
        }
        input:invalid:not(:focus), select:invalid:not(:focus) {
            border-color: #d32f2f;
        }
        input[readonly] {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            padding: 12px 25px;
            margin: 20px 10px 0 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #1976D2;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #d32f2f;
        }
        .container {
            border: 1px solid #e5e5e5;
            padding: 20px;
            margin-top: 20px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        .section {
            padding: 20px;
            background-color: #fefefe;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ececec;
        }
        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .row div {
            flex: 1;
            min-width: 200px;
        }
        .escala-section {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-left: 4px solid #2196F3;
        }
        .relatorio-section {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            border-left: 4px solid #4CAF50;
        }
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            .row div { 
                min-width: 100%; 
            }
            button { 
                width: 100%; 
                margin: 10px 0; 
                padding: 10px; 
                font-size: 14px; 
            }
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Cabeçalho do Sistema -->
        <div class="system-header">
            <h1><i class="fas fa-clipboard-list"></i> Sistema CEOPE - Via Livre</h1>
            <p>Geração de Escalas e Relatórios Operacionais</p>
        </div>

        <!-- Navegação por Abas -->
        <div class="module-container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('escala')">
                    <i class="fas fa-calendar-alt"></i> Gerador de Escalas
                </button>
                <button class="tab" onclick="showTab('relatorio')">
                    <i class="fas fa-file-alt"></i> Relatório Operacional
                </button>
            </div>

            <!-- Aba: Gerador de Escalas -->
            <div id="escala" class="tab-content active">
                <div class="module-header">
                    <i class="fas fa-calendar-alt icon"></i>
                    <h2>Gerador de Escalas de Trabalho</h2>
                </div>

                <div class="feature-grid">
                    <div class="feature-card">
                        <h3><i class="fas fa-file-excel"></i> Planilha Excel</h3>
                        <p>Gera automaticamente planilha de escala para download</p>
                    </div>
                    <div class="feature-card">
                        <h3><i class="fas fa-calculator"></i> Contagem Inteligente</h3>
                        <p>Conta trabalhadores excluindo supervisores do topo</p>
                    </div>
                    <div class="feature-card">
                        <h3><i class="fab fa-whatsapp"></i> Texto WhatsApp</h3>
                        <p>Formata texto pronto para envio no WhatsApp</p>
                    </div>
                    <div class="feature-card">
                        <h3><i class="fas fa-save"></i> Sistema de Rascunho</h3>
                        <p>Salva e carrega escalas em desenvolvimento</p>
                    </div>
                </div>

                <div class="section escala-section">
                    <h3>Dados da Escala</h3>
                    <div class="row">
                        <div>
                            <label for="escalaData" class="required">Data da Escala:</label>
                            <input type="date" id="escalaData" required>
                        </div>
                        <div>
                            <label for="escalaTurno" class="required">Turno:</label>
                            <select id="escalaTurno" required>
                                <option value="">Selecione o turno</option>
                                <option value="MADRUGADA">Madrugada</option>
                                <option value="MANHÃ">Manhã</option>
                                <option value="TARDE">Tarde</option>
                                <option value="NOITE">Noite</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label for="escalaSupervisorPrincipal" class="required">Supervisores Principais (não contam):</label>
                            <input type="text" id="escalaSupervisorPrincipal" placeholder="Digite os nomes dos supervisores principais" required>
                        </div>
                        <div>
                            <label for="escalaSupervisorAuxiliar" class="required">Supervisor Auxiliar (conta):</label>
                            <input type="text" id="escalaSupervisorAuxiliar" placeholder="Digite o nome do supervisor auxiliar" required>
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label for="escalaMonitor">Monitor da Central:</label>
                            <input type="text" id="escalaMonitor" placeholder="Digite o nome do monitor">
                        </div>
                        <div>
                            <label for="escalaTotalTrabalhadores">Total de Trabalhadores:</label>
                            <input type="number" id="escalaTotalTrabalhadores" readonly>
                        </div>
                    </div>
                </div>

                <div class="section escala-section">
                    <h3>Distribuição de Trabalhadores</h3>
                    <div id="trabalhadoresContainer" class="container">
                        <!-- Trabalhadores serão adicionados dinamicamente -->
                    </div>
                    <button id="btnAdicionarTrabalhador"><i class="fas fa-plus"></i> Adicionar Trabalhador</button>
                    <button id="btnAdicionarRegiao" class="secondary"><i class="fas fa-map-marker-alt"></i> Adicionar Região</button>
                </div>

                <div class="section escala-section">
                    <h3>Ações da Escala</h3>
                    <button id="btnSalvarEscala"><i class="fas fa-save"></i> Salvar Escala</button>
                    <button id="btnCarregarEscala" class="secondary"><i class="fas fa-folder-open"></i> Carregar Escala</button>
                    <button id="btnGerarExcelEscala"><i class="fas fa-file-excel"></i> Gerar Excel da Escala</button>
                    <button id="btnGerarWhatsApp"><i class="fab fa-whatsapp"></i> Gerar Texto WhatsApp</button>
                    <button id="btnPreviewEscala" class="secondary"><i class="fas fa-eye"></i> Pré-visualizar</button>
                </div>
            </div>

            <!-- Aba: Relatório Operacional (código original) -->
            <div id="relatorio" class="tab-content">
                <div class="module-header">
                    <i class="fas fa-file-alt icon"></i>
                    <h2>Relatório Operacional de Turno</h2>
                </div>

                <div class="section relatorio-section">
                    <div class="row">
                        <div>
                            <label for="data" class="required">Data:</label>
                            <input type="date" id="data" required>
                        </div>
                        <div>
                            <label for="turno" class="required">Turno:</label>
                            <select id="turno" required>
                                <option value="">Selecione o turno</option>
                                <option value="MADRUGADA">Madrugada</option>
                                <option value="MANHÃ">Manhã</option>
                                <option value="TARDE">Tarde</option>
                                <option value="NOITE">Noite</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label for="supervisor" class="required">Supervisor (Nome e Telefone):</label>
                            <input type="text" id="supervisor" placeholder="Digite o nome e telefone do supervisor" required>
                        </div>
                        <div>
                            <label for="totalOperadores" class="required">Total de Operadores:</label>
                            <input type="number" id="totalOperadores" min="0" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div>
                            <label for="internos">Internos:</label>
                            <input type="number" id="internos" min="0" readonly>
                        </div>
                        <div>
                            <label for="externos">Externos:</label>
                            <input type="number" id="externos" min="0" readonly>
                        </div>
                    </div>
                </div>

                <div class="section relatorio-section">
                    <h3>Divisão das Operações</h3>
                    <label for="central">01. Central:</label>
                    <input type="text" id="central" placeholder="Digite os nomes dos operadores" list="operadoresList">
                    <datalist id="operadoresList"></datalist>
                    
                    <label>02. Postos Fixos:</label>
                    <div id="postosFixosContainer" class="container"></div>
                    <button id="btnPostosFixos"><i class="fas fa-plus"></i> Adicionar Posto Fixo</button>
                    
                    <label>03. Equipe Volante:</label>
                    <div id="equipeVolanteContainer" class="container"></div>
                    <button id="btnEquipeVolante"><i class="fas fa-plus"></i> Adicionar Equipe Volante</button>

                    <label>04. Missão ou Evento:</label>
                    <div id="missaoContainer" class="container"></div>
                    <button id="btnMissao"><i class="fas fa-plus"></i> Adicionar Missão/Evento</button>

                    <label>05. Supervisão:</label>
                    <div id="supervisaoContainer" class="container"></div>
                    <button id="btnAdicionarSupervisao"><i class="fas fa-plus"></i> Adicionar Supervisão</button>

                    <label for="observacoes">06. Observações:</label>
                    <textarea id="observacoes" rows="3" placeholder="Digite observações gerais"></textarea>

                    <div id="errorMessage" style="color: #d32f2f; font-size: 14px; margin-top: 15px; display: none; font-weight: 500;">
                        Por favor, preencha todos os campos obrigatórios marcados com *.
                    </div>
                    
                    <button id="btnSalvarRascunho"><i class="fas fa-save"></i> Salvar Rascunho</button>
                    <button id="btnCarregarRascunho" class="secondary"><i class="fas fa-folder-open"></i> Carregar Rascunho</button>
                    <button id="btnPreVisualizar" class="secondary"><i class="fas fa-eye"></i> Pré-visualizar</button>
                    <button id="gerarPdfBtn"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                    <button id="gerarExcelBtn"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let regioes = JSON.parse(localStorage.getItem("regioesPersonalizadas")) || [
            "ALDEOTA", "CENTRO", "CIDADE DOS FUNCIONÁRIOS", "MARAPONGA", "PAPICU", "PARANGABA"
        ].sort((a, b) => a.localeCompare(b));
        
        let operadores = JSON.parse(localStorage.getItem("operadoresPersonalizados")) || [
            "ACÁCIO", "ADAMS", "ANCHIETA DA SILVA", "BACELAR", "BRUNO", "BRUNO ALBUQUERQUE", "CALACIO",
            "CARLOS ALBERTO", "CARLOS ALEX", "CARLOS EDUARDO", "CRISTIANO", "DANRLEI", "DAVID", "DELUCAS",
            "DENIS", "EDILBERTO", "ELIZIÁRIO", "EMANUEL PINHEIRO", "EMERSON", "ERICK", "FABRÍCIO", "FELIPE",
            "FRANCISCO", "FRANCISCO THIAGO", "GABRIEL RIBEIRO", "GENILSON", "GOMES", "HUDSON", "ITALO",
            "JAIRO", "JOAN", "JOÃO LUCAS", "JOÃO PAULO", "JORGE LUIS", "JOSÉ AIRTON", "JOSÉ ARY",
            "JOSÉ MOREIRA", "JOSE RONALDO", "JULIO CESAR", "LEONI", "LUCAS CAVALCANTE", "MAIA", "MAICON",
            "MÁRCIO", "MARCELO ARAÚJO", "MARLON", "MIGUEL", "MIZAEL", "NEGREIROS", "NEIRTON", "NONATO",
            "ONILDO", "PAULO SÉRGIO", "PAULO TELES", "PEDRO LESSA", "PEDRO MARQUES", "ROBSON", "RONALDO",
            "SALES", "SANTANA", "SIDNEY", "THAYANNE", "THIAGO CÉSAR", "THIAGO NOGUEIRA", "UIRAQUÊ",
            "WESLEY SILVA", "ZAMISK"
        ].sort((a, b) => a.localeCompare(b));

        // Função para alternar entre abas
        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Função para contar trabalhadores na escala (contagem inteligente)
        function contarTrabalhadores() {
            const supervisoresPrincipais = document.getElementById("escalaSupervisorPrincipal").value;
            const supervisorAuxiliar = document.getElementById("escalaSupervisorAuxiliar").value;
            
            let totalTrabalhadores = 0;
            
            // Contar supervisor auxiliar (conta)
            if (supervisorAuxiliar.trim()) {
                totalTrabalhadores += contarNomes(supervisorAuxiliar);
            }
            
            // Contar todos os trabalhadores adicionados
            const trabalhadoresInputs = document.querySelectorAll('#trabalhadoresContainer input[placeholder="Digite os nomes dos trabalhadores"]');
            trabalhadoresInputs.forEach(input => {
                totalTrabalhadores += contarNomes(input.value);
            });
            
            // NÃO contar supervisores principais (conforme especificação)
            
            document.getElementById("escalaTotalTrabalhadores").value = totalTrabalhadores;
            return totalTrabalhadores;
        }

        // Função auxiliar para contar nomes
        function contarNomes(texto) {
            if (!texto.trim()) return 0;
            const nomes = texto.split(',')
                .map(nome => nome.trim())
                .filter(nome => nome.length > 0);
            return nomes.length;
        }

        // Função para adicionar trabalhador
        function adicionarTrabalhador() {
            const container = document.getElementById("trabalhadoresContainer");
            const div = document.createElement("div");
            div.className = "row";
            div.style.marginBottom = "15px";
            div.innerHTML = `
                <div style="flex: 1;">
                    <select class="regiao-select">
                        <option value="">Selecione a região</option>
                        ${regioes.map(r => `<option value="${r}">${r}</option>`).join("")}
                    </select>
                </div>
                <div style="flex: 2;">
                    <input type="text" placeholder="Digite os nomes dos trabalhadores" onchange="contarTrabalhadores()">
                </div>
                <div style="flex: 1;">
                    <input type="text" placeholder="Função/Posto">
                </div>
                <div style="flex: 0 0 auto;">
                    <button class="danger" onclick="this.parentElement.parentElement.remove(); contarTrabalhadores();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
            contarTrabalhadores();
        }

        // Função para gerar Excel da escala
        function gerarExcelEscala() {
            if (!document.getElementById("escalaData").value || !document.getElementById("escalaTurno").value) {
                alert("Por favor, preencha a data e o turno da escala.");
                return;
            }

            const data = document.getElementById("escalaData").value;
            const turno = document.getElementById("escalaTurno").value;
            const supervisoresPrincipais = document.getElementById("escalaSupervisorPrincipal").value;
            const supervisorAuxiliar = document.getElementById("escalaSupervisorAuxiliar").value;
            const monitor = document.getElementById("escalaMonitor").value;
            const total = document.getElementById("escalaTotalTrabalhadores").value;

            // Criar dados da planilha
            const dadosEscala = [];
            
            // Cabeçalho
            dadosEscala.push([`ESCALA DE TRABALHO - ${turno}`, "", "", ""]);
            dadosEscala.push([`Data: ${formatarData(data)}`, "", "", ""]);
            dadosEscala.push(["", "", "", ""]);
            
            // Supervisores principais (não contam)
            dadosEscala.push(["SUPERVISORES:", supervisoresPrincipais, "", ""]);
            dadosEscala.push(["", "", "", ""]);
            
            // Supervisor auxiliar (conta)
            dadosEscala.push(["SUPERVISOR AUXILIAR:", supervisorAuxiliar, "", ""]);
            dadosEscala.push(["", "", "", ""]);
            
            // Monitor
            if (monitor) {
                dadosEscala.push(["MONITOR:", monitor, "", ""]);
                dadosEscala.push(["", "", "", ""]);
            }
            
            // Cabeçalho da tabela
            dadosEscala.push(["REGIÃO", "TRABALHADORES", "FUNÇÃO/POSTO", "OBSERVAÇÕES"]);
            
            // Trabalhadores
            const trabalhadoresRows = document.querySelectorAll('#trabalhadoresContainer .row');
            trabalhadoresRows.forEach(row => {
                const regiao = row.querySelector('.regiao-select').value || "NÃO INFORMADO";
                const trabalhadores = row.querySelector('input[placeholder="Digite os nomes dos trabalhadores"]').value || "";
                const funcao = row.querySelector('input[placeholder="Função/Posto"]').value || "";
                dadosEscala.push([regiao, trabalhadores, funcao, ""]);
            });
            
            // Total
            dadosEscala.push(["", "", "", ""]);
            dadosEscala.push(["TOTAL DE TRABALHADORES:", total, "", ""]);

            // Criar workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dadosEscala);
            
            // Adicionar worksheet
            XLSX.utils.book_append_sheet(wb, ws, "Escala");
            
            // Download
            const filename = `Escala_${turno}_${data.replace(/-/g, '')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Função para gerar texto WhatsApp
        function gerarTextoWhatsApp() {
            if (!document.getElementById("escalaData").value || !document.getElementById("escalaTurno").value) {
                alert("Por favor, preencha a data e o turno da escala.");
                return;
            }

            const data = formatarData(document.getElementById("escalaData").value);
            const turno = document.getElementById("escalaTurno").value;
            const supervisorAuxiliar = document.getElementById("escalaSupervisorAuxiliar").value;
            const monitor = document.getElementById("escalaMonitor").value;
            const total = document.getElementById("escalaTotalTrabalhadores").value;

            let texto = `TURNO: ${turno}\\n`;
            texto += `${data}\\n`;
            texto += `TOTAL AGENTES: ${total}\\n`;
            
            if (monitor) {
                texto += `CENTRAL: ${monitor.toUpperCase()}\\n`;
            }
            
            if (supervisorAuxiliar) {
                texto += `SUPERVISÃO: ${supervisorAuxiliar.toUpperCase()}\\n`;
            }
            
            texto += `\\n`;
            
            // Adicionar trabalhadores por região
            const trabalhadoresRows = document.querySelectorAll('#trabalhadoresContainer .row');
            trabalhadoresRows.forEach(row => {
                const regiao = row.querySelector('.regiao-select').value;
                const trabalhadores = row.querySelector('input[placeholder="Digite os nomes dos trabalhadores"]').value;
                const funcao = row.querySelector('input[placeholder="Função/Posto"]').value;
                
                if (regiao && trabalhadores) {
                    texto += `${regiao}: ${trabalhadores.toUpperCase()}`;
                    if (funcao) {
                        texto += ` (${funcao.toUpperCase()})`;
                    }
                    texto += `\\n`;
                }
            });

            // Mostrar em modal ou copiar para clipboard
            const modal = window.open("", "_blank", "width=600,height=400");
            modal.document.write(`
                <html>
                <head><title>Texto para WhatsApp</title></head>
                <body style="font-family: Arial; padding: 20px;">
                    <h3>Texto formatado para WhatsApp:</h3>
                    <textarea style="width: 100%; height: 300px; font-family: monospace;">${texto.replace(/\\n/g, '\\n')}</textarea>
                    <br><br>
                    <button onclick="navigator.clipboard.writeText('${texto.replace(/\\n/g, '\\n')}'); alert('Texto copiado!');">Copiar Texto</button>
                </body>
                </html>
            `);
        }

        // Função para salvar escala
        function salvarEscala() {
            const escala = {
                data: document.getElementById("escalaData").value,
                turno: document.getElementById("escalaTurno").value,
                supervisoresPrincipais: document.getElementById("escalaSupervisorPrincipal").value,
                supervisorAuxiliar: document.getElementById("escalaSupervisorAuxiliar").value,
                monitor: document.getElementById("escalaMonitor").value,
                trabalhadores: []
            };

            const trabalhadoresRows = document.querySelectorAll('#trabalhadoresContainer .row');
            trabalhadoresRows.forEach(row => {
                escala.trabalhadores.push({
                    regiao: row.querySelector('.regiao-select').value,
                    nomes: row.querySelector('input[placeholder="Digite os nomes dos trabalhadores"]').value,
                    funcao: row.querySelector('input[placeholder="Função/Posto"]').value
                });
            });

            localStorage.setItem("escalaRascunho", JSON.stringify(escala));
            alert("Escala salva com sucesso!");
        }

        // Função para carregar escala
        function carregarEscala() {
            const escala = JSON.parse(localStorage.getItem("escalaRascunho"));
            if (!escala) {
                alert("Nenhuma escala salva encontrada.");
                return;
            }

            document.getElementById("escalaData").value = escala.data || "";
            document.getElementById("escalaTurno").value = escala.turno || "";
            document.getElementById("escalaSupervisorPrincipal").value = escala.supervisoresPrincipais || "";
            document.getElementById("escalaSupervisorAuxiliar").value = escala.supervisorAuxiliar || "";
            document.getElementById("escalaMonitor").value = escala.monitor || "";

            // Limpar container
            document.getElementById("trabalhadoresContainer").innerHTML = "";

            // Adicionar trabalhadores
            escala.trabalhadores.forEach(trabalhador => {
                adicionarTrabalhador();
                const lastRow = document.querySelector('#trabalhadoresContainer .row:last-child');
                lastRow.querySelector('.regiao-select').value = trabalhador.regiao;
                lastRow.querySelector('input[placeholder="Digite os nomes dos trabalhadores"]').value = trabalhador.nomes;
                lastRow.querySelector('input[placeholder="Função/Posto"]').value = trabalhador.funcao;
            });

            contarTrabalhadores();
            alert("Escala carregada com sucesso!");
        }

        // Função para formatar data
        function formatarData(data) {
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // Event listeners
        document.addEventListener("DOMContentLoaded", function() {
            // Eventos da escala
            document.getElementById("btnAdicionarTrabalhador").addEventListener("click", adicionarTrabalhador);
            document.getElementById("btnSalvarEscala").addEventListener("click", salvarEscala);
            document.getElementById("btnCarregarEscala").addEventListener("click", carregarEscala);
            document.getElementById("btnGerarExcelEscala").addEventListener("click", gerarExcelEscala);
            document.getElementById("btnGerarWhatsApp").addEventListener("click", gerarTextoWhatsApp);

            // Eventos de contagem
            document.getElementById("escalaSupervisorAuxiliar").addEventListener("input", contarTrabalhadores);

            // Adicionar primeiro trabalhador por padrão
            adicionarTrabalhador();
        });

        // Aqui continuaria com todo o código original do relatório operacional...
        // [O código completo do sistema original seria inserido aqui]
    </script>
</body>
</html>

